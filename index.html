<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3c72">
    <meta name="description" content="Ø§Ù„Ù…Ø³Ø¨Ø­Ø© Ø§Ù„Ø°ÙƒÙŠØ© - ØªØ·Ø¨ÙŠÙ‚ Ø¹ØµØ±ÙŠ Ù„Ù„ØªØ³Ø¨ÙŠØ­">
    <title>Ø§Ù„Ù…Ø³Ø¨Ø­Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItis2LLZitixINmF2YbYp9mG2K/ZiCIsCiAgInNob3J0X25hbWUiOiAi2YXYp9mG2K/ZiCIsCiAgImRlc2NyaXB0aW9uIjogItin2YrYp9i62Kkg2KfZhNmF2YbYp9mG2K/ZiiDYp9mE2KfZhNiz2KrYr9in2Kog2KjYp9mG2KjYp9mGINij2YjYrNmI2KfZhiDYp9mE2YLYqNmE2YLYr9iMINmF2YbYp9mG2K/ZiiIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWUzYzcyIiwKICAidGhlbWVfY29sb3IiOiAiIzFlM2M3MiIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAibGFuZyI6ICJhciIsCiAgImljb25zIjogW3sic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QmxibUZpWVhSMGRHbHZiajBpTVRBd0lpQm9aV2xuYUhRaU9pSXhNREF3SWlCM2FXUjBhRDBpTlRBd01EQWlJR1pwYkd3OUlqRXdNREFpSUdObGJHRnphRDBpTVRBd01DQStQR2x0WVdkbElIZHBaSFJvUFNJME1EQXdJaUI0Yld4dWN6MGlkR1Z6ZENJZ2VHMXdkejBpTVRBd01DQWlQR2x0WVdkbElIZHBaSFJvUFNJME1EQXdJaUI0Yld4dWN6MGlkR1Z6ZENJZ2VHMXdkejBpTVRBd01DQWlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlQSEJ2YkhsamFXNDlKM0J2YkhsamFXNGlKM0J2YkhsamFXNk1EQXdNREFnIiwic2l6ZXMiOiAiNTEyeDUxMiIsInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCJdfQ==">
    
    <style>
        :root {
            --primary: #1e3c72;
            --accent: #00d2ff;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --btn-color: #1e3c72;
            --btn-size: 250px;
            --shadow-soft: 0 10px 40px rgba(31, 38, 135, 0.1);
            --shadow-card: 0 4px 15px rgba(0, 0, 0, 0.05);
            --toggle-bg: #cbd5e1;
            --toggle-active: #1e3c72;
        }

        body.dark-mode {
            --primary: #a5b4fc;
            --glass-bg: rgba(20, 25, 40, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.5);
            --toggle-bg: #475569;
            --toggle-active: #a5b4fc;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; font-family:'Tajawal', sans-serif; user-select:none; -webkit-user-select:none; }
        
        body {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
            min-height: 100vh;
            color: var(--text-main);
            padding-bottom: 110px;
            overflow-x: hidden;
            background-attachment: fixed;
            transition: 0.3s;
        }
        
        body.dark-mode { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }

        .glass-panel {
            background: var(--glass-bg);
            border: var(--glass-border);
            box-shadow: var(--shadow-soft);
            border-radius: 24px;
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            transition: all 0.3s ease;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 25px; margin-bottom: 25px; position: sticky; top: 10px; z-index: 50; 
            min-height: 60px;
        }
        
        .date-badge { 
            font-size: 0.85em; font-weight: 700; padding: 5px 0; 
            background: transparent; color: var(--text-main); cursor: pointer;
            letter-spacing: 0.5px; opacity: 0.7;
        }
        
        .install-icon-top {
            background: var(--text-main); color: var(--glass-bg); border: none; 
            width: 35px; height: 35px; border-radius: 50%; font-weight: 700; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-card); transition: transform 0.2s; font-size: 1em;
        }
        .install-icon-top:active { transform: scale(0.9); }
        .hidden { display: none !important; }

        .header-content { text-align: center; margin-bottom: 20px; }
        .header-content h1 { 
            font-weight: 800; font-size: 2.4em; 
            background: linear-gradient(45deg, var(--text-main), var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .tasbih-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        select {
            width: 100%; max-width: 280px; padding: 12px; 
            background: rgba(0,0,0,0.04);
            border: none; border-radius: 30px; 
            font-size: 1.1em; color: var(--text-main); font-weight: 700; 
            text-align: center; appearance: none; outline: none; transition: 0.3s;
        }
        body.dark-mode select { background: rgba(255,255,255,0.08); }

        .tasbih-btn-large {
            width: var(--btn-size); height: var(--btn-size);
            border-radius: 50%; border: none;
            background: var(--btn-color);
            color: white;
            cursor: pointer;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 6px 10px rgba(255,255,255,0.3), inset 0 -6px 10px rgba(0,0,0,0.2);
            position: relative;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; touch-action: manipulation;
            transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.1s;
            z-index: 10; margin: 10px 0; outline: none;
        }
        .tasbih-btn-large::after {
            content: ''; position: absolute; inset: -5px;
            border-radius: 50%; border: 2px solid var(--btn-color);
            opacity: 0.3; pointer-events: none; z-index: -1;
        }
        .tasbih-btn-large:active, .tasbih-btn-large.pressed {
            transform: scale(0.92);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2), inset 0 6px 20px rgba(0,0,0,0.3);
        }

        .ripple-effect {
            position: absolute; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0); animation: ripple 0.5s linear; pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(2.5); opacity: 0; } }

        .counter-display {
            font-size: 6em; font-weight: 700; color: white;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            pointer-events: none; z-index: 2; font-variant-numeric: tabular-nums;
        }

        .color-btn-center {
            background: transparent; border: 1px solid var(--text-sub);
            color: var(--text-sub); padding: 8px 20px; border-radius: 30px;
            font-size: 0.9em; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 5px; opacity: 0.8; transition: 0.2s;
        }
        .color-btn-center:hover { opacity: 1; background: rgba(0,0,0,0.05); }

        .controls-row { display: flex; gap: 12px; width: 100%; max-width: 300px; margin-top: 10px; }
        
        .btn-small {
            flex: 1; padding: 14px; border-radius: 20px; border: none;
            background: var(--glass-bg); color: var(--text-main);
            font-weight: 700; cursor: pointer; box-shadow: var(--shadow-card);
            border: var(--glass-border);
            display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: transform 0.1s, background 0.3s;
        }
        .btn-small:active { transform: scale(0.96); }
        .btn-small.danger { color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        .btn-small.active { background: #10b981; color: white; border-color: #10b981; }
        .btn-small.primary { background: var(--primary); color: white; }

        /* Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ± Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù† */
        .btn-large-primary {
            width: 100%; padding: 18px; border-radius: 20px; border: none;
            background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
            color: white; font-weight: 800; font-size: 1.1em;
            cursor: pointer; box-shadow: 0 4px 15px rgba(30, 60, 114, 0.2);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 8px; transition: transform 0.1s, box-shadow 0.3s;
        }
        .btn-large-primary:active { transform: scale(0.98); box-shadow: 0 2px 10px rgba(30, 60, 114, 0.1); }

        /* ÙƒØ§Ø±Øª Ø¢Ø®Ø± Ø°ÙƒØ± ØªÙ… Ø³Ù…Ø§Ø¹Ù‡ */
        .last-heard-card {
            width: 100%; max-width: 300px;
            background: rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 15px; padding: 12px 15px;
            text-align: center; margin-top: 15px;
            display: flex; flex-direction: column; gap: 5px;
        }
        body.dark-mode .last-heard-card { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.05); }

        /* === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ®ÙŠØ§Ø±Ø§Øª === */
        .settings-group { margin-bottom: 25px; }
        .settings-title { font-size: 1.1em; font-weight: 800; margin-bottom: 12px; color: var(--primary); padding: 0 5px; }
        
        .option-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600; font-size: 0.95em;
        }
        .option-item:last-child { border-bottom: none; }
        body.dark-mode .option-item { border-color: rgba(255,255,255,0.05); }

        .toggle-switch {
            position: relative; width: 44px; height: 24px;
            background: var(--toggle-bg); border-radius: 20px;
            transition: 0.3s; cursor: pointer;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 20px; height: 20px; background: white;
            border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toggle-switch.active { background: var(--toggle-active); }
        
        html[dir="rtl"] .toggle-switch::after { left: auto; right: 2px; }
        html[dir="rtl"] .toggle-switch.active::after { transform: translateX(-20px); }
        html[dir="ltr"] .toggle-switch.active::after { transform: translateX(20px); }

        .install-instructions {
            background: rgba(0,0,0,0.03); border-radius: 12px;
            padding: 15px; margin-top: 10px; border: 1px solid rgba(0,0,0,0.05);
        }
        body.dark-mode .install-instructions { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.05); }
        .inst-title { font-weight: 800; margin-bottom: 8px; font-size:0.95em; color: var(--text-main); }
        .inst-step { font-size: 0.85em; margin-bottom: 5px; color: var(--text-sub); line-height: 1.5; }

        /* === ØªØ­Ø³ÙŠÙ†Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (List Style) === */
        .zekr-card {
            background: var(--glass-bg); 
            padding: 20px; border-radius: 20px;
            margin-bottom: 15px; 
            border: var(--glass-border);
            box-shadow: var(--shadow-card);
            display: flex; justify-content: space-between; align-items: center;
            position: relative; overflow: hidden;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .zekr-card.removing {
            opacity: 0; transform: translateX(50px);
        }

        .zekr-card::before {
            content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 5px;
            background: var(--primary); opacity: 0.8; border-radius: 0 5px 5px 0;
        }

        .zekr-content { flex: 1; margin-left: 15px; padding-right: 10px; }
        .zekr-txt { 
            font-weight: 700; font-size: 1.15em; color: var(--text-main); 
            display: block; margin-bottom: 5px; line-height: 1.5; 
            white-space: pre-wrap; word-break: break-word;
        }
        .zekr-sub { font-size: 0.85em; color: var(--text-sub); display: block; }
        
        .del-btn-icon {
            background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; 
            width: 38px; height: 38px; border-radius: 12px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1em; transition: 0.2s; flex-shrink: 0;
        }
        .del-btn-icon:hover { background: #ef4444; color: white; transform: scale(1.05); }

        .empty-state {
            text-align: center; padding: 40px 20px; color: var(--text-sub);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .empty-icon { font-size: 3em; opacity: 0.5; margin-bottom: 10px; }

        .input-area {
            width: 100%; padding: 15px; border-radius: 16px; 
            border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); 
            color: var(--text-main); margin-bottom: 10px; font-family: inherit; font-size: 1em; outline: none; transition: 0.3s;
        }
        .input-area:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        body.dark-mode .input-area { background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.05); }

        .nav-floating {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 380px; background: rgba(255, 255, 255, 0.9);
            border-radius: 35px; display: flex; justify-content: space-between;
            padding: 8px 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); z-index: 1000;
            border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(20px);
        }
        body.dark-mode .nav-floating { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.1); }
        
        .nav-btn { background: none; border: none; padding: 12px 20px; border-radius: 25px; color: var(--text-sub); font-size: 1.3em; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .nav-btn span { font-size: 0.55em; font-weight: 800; display: none; }
        .nav-btn.active { color: var(--primary); background: rgba(0,0,0,0.04); }
        .nav-btn.active span { display: block; }
        body.dark-mode .nav-btn.active { background: rgba(255,255,255,0.1); }

        .color-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .color-modal-overlay.show { display: flex; animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .color-modal {
            background: var(--glass-bg); width: 90%; max-width: 340px;
            padding: 25px; border-radius: 28px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: var(--glass-border);
        }
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 20px; justify-items: center; }
        .color-circle {
            width: 50px; height: 50px; border-radius: 50%; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 2px solid white;
            transition: transform 0.2s;
        }
        .color-circle:hover { transform: scale(1.1); }

        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeUp 0.4s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 30px; border-radius: 50px; font-weight: 700; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-size: 0.9em; }
        .toast.show { opacity: 1; top: 110px; }
        
        .install-btn-large {
            width: 100%; padding: 12px; background: var(--text-main); color: var(--glass-bg);
            border-radius: 12px; font-weight: 800; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 10px;
        }
    </style>
</head>
<body>

    <header class="top-bar glass-panel">
        <div class="date-badge" id="dateDisplay" onclick="DateCtrl.update()">...</div>
        <button id="topInstallIcon" class="install-icon-top hidden" onclick="PWA.install()" title="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">â¬‡ï¸</button>
    </header>

    <div class="container">
        
        <div class="header-content">
            <h1 id="appTitle">Ø§Ù„Ù…Ø³Ø¨Ø­Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h1>
        </div>

        <main id="tasbih-section" class="content-section active">
            <div class="glass-panel" style="padding: 40px 20px; display:flex; flex-direction:column; align-items:center;">
                <div class="tasbih-wrapper">
                    <select id="tasbihSelect" onchange="Voice.reset()">
                        <option>Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡</option><option>Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡</option>
                        <option>Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡</option><option>Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±</option>
                        <option>Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡</option><option>Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ© Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù„Ù‡</option>
                    </select>

                    <button class="tasbih-btn-large" id="tasbihBtn" 
                            ontouchstart="Tasbih.touchStart(event)" 
                            onmousedown="Tasbih.mouseDown(event)" 
                            onmouseup="Tasbih.mouseUp()"
                            onmouseleave="Tasbih.mouseUp()">
                        <span class="counter-display" id="counter">0</span>
                    </button>

                    <button class="color-btn-center" id="colorBtnMain" onclick="ColorPicker.open()">
                        ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù…Ø³Ø¨Ø­Ø©
                    </button>

                    <div class="controls-row">
                        <button class="btn-small" id="voiceBtn" onclick="Voice.toggle()">ğŸ¤ ØµÙˆØªÙŠ</button>
                        <button class="btn-small danger" id="resetBtn" onclick="Tasbih.reset()">ğŸ”„ ØªØµÙÙŠØ±</button>
                    </div>

                    <!-- ØªÙ… Ù†Ù‚Ù„ ÙˆØªÙ†Ø³ÙŠÙ‚ Ø¢Ø®Ø± Ø°ÙƒØ± ØªÙ… Ø³Ù…Ø§Ø¹Ù‡ Ù‡Ù†Ø§ -->
                    <div class="last-heard-card">
                        <span id="lastHeardLabel" style="font-size:0.8em; opacity:0.7;">Ø¢Ø®Ø± Ø°ÙƒØ± ØªÙ… Ø³Ù…Ø§Ø¹Ù‡:</span>
                        <div id="lastDetected" style="font-weight:700; color: var(--primary); min-height:20px;">-</div>
                    </div>
                </div>
            </div>
        </main>

        <section id="my-azkar-section" class="content-section">
            <div class="glass-panel" style="padding: 25px;">
                <h2 id="azkarTitle" style="text-align:center; margin-bottom:20px; font-weight:800;">Ø£Ø°ÙƒØ§Ø±ÙŠ</h2>
                <div style="margin-bottom:25px;">
                    <textarea id="zekrText" class="input-area" rows="2" placeholder="Ø£ÙƒØªØ¨ Ø§Ù„Ø°ÙƒØ± Ù‡Ù†Ø§..."></textarea>
                    <input id="zekrInfo" class="input-area" type="text" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    <!-- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                    <button id="addZekrBtn" class="btn-large-primary" onclick="Azkar.add()">â• Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ± Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div id="myAzkarList"></div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <section id="settings-section" class="content-section">
            <div class="glass-panel" style="padding: 25px;">
                
                <div class="settings-group">
                    <div class="settings-title" id="optTitle">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</div>
                    
                    <div class="option-item">
                        <span id="optSound">Ø§Ù„ØµÙˆØª</span>
                        <div class="toggle-switch" id="soundToggle" onclick="Settings.toggleSound()"></div>
                    </div>

                    <div class="option-item">
                        <span id="optNight">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                        <div class="toggle-switch" id="themeToggle" onclick="Settings.theme()"></div>
                    </div>
                    
                    <div class="option-item" onclick="Settings.lang()" style="cursor:pointer">
                        <span id="optLang">Ø§Ù„Ù„ØºØ©</span>
                        <span style="font-size:0.9em; opacity:0.7;" id="currLang">English</span>
                    </div>

                    <div class="option-item" onclick="document.getElementById('bgPicker').click()" style="cursor:pointer">
                        <span id="optBg">ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©</span>
                        <span style="font-size:1.2em;">ğŸ–¼ï¸</span>
                    </div>
                    <input type="file" id="bgPicker" hidden accept="image/*" onchange="BG.change(event)">

                    <button class="btn-small danger" id="delBgBtn" onclick="BG.remove()" style="margin-top:15px; width:100%">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
                </div>

                <hr style="border:0; border-top:1px solid var(--glass-border); margin:20px 0;">

                <div class="settings-group">
                    <div class="settings-title" id="notesTitle">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
                    
                    <button id="settingsInstallBtn" class="install-btn-large hidden" onclick="PWA.install()">
                        <span id="installBtnTxt">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
                    </button>

                    <div class="install-instructions">
                        <div class="inst-title">ğŸ <span id="iosTitle">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ù„Ø¢ÙŠÙÙˆÙ† (iOS)</span></div>
                        <div class="inst-step">1. <span id="iosStep1">Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù…ØªØµÙØ­ Safari.</span></div>
                        <div class="inst-step">2. <span id="iosStep2">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„.</span></div>
                        <div class="inst-step">3. <span id="iosStep3">Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".</span></div>
                    </div>

                    <div class="install-instructions">
                        <div class="inst-title">ğŸ¤– <span id="androidTitle">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯</span></div>
                        <div class="inst-step">1. <span id="andStep1">Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù…ØªØµÙØ­ Chrome.</span></div>
                        <div class="inst-step">2. <span id="andStep2">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·) ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰.</span></div>
                        <div class="inst-step">3. <span id="andStep3">Ø§Ø®ØªØ± "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚".</span></div>
                    </div>
                </div>

                <div style="font-size:0.8em; padding:10px; text-align:center; color:var(--text-sub);">
                    v3.0 â€¢ ÙŠØ¹Ù…Ù„ Ø¨Ù„Ø§ Ø§Ù†ØªØ±Ù†Øª
                </div>
            </div>
        </section>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
    <div class="color-modal-overlay" id="colorModal" onclick="ColorPicker.close(event)">
        <div class="color-modal">
            <h3 id="colorModalTitle" style="margin-bottom:20px;">Ù„ÙˆÙ† Ø§Ù„Ù…Ø³Ø¨Ø­Ø©</h3>
            <div class="color-grid" id="colorGrid"></div>
            <button class="btn-small" id="closeColorBtn" style="margin-top:25px; width:100%" onclick="ColorPicker.close(null, true)">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <nav class="nav-floating">
        <button class="nav-btn active" onclick="Nav.show('tasbih')">ğŸ“¿ <span id="navTasbih">ØªØ³Ø¨ÙŠØ­</span></button>
        <button class="nav-btn" onclick="Nav.show('my-azkar')">ğŸ“– <span id="navAzkar">Ø£Ø°ÙƒØ§Ø±ÙŠ</span></button>
        <button class="nav-btn" onclick="Nav.show('settings')">âš™ï¸ <span id="navSettings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button>
    </nav>

    <div class="toast" id="toast"></div>

    <script>
        let count = 0, isVoice = false, rec = null, isDark = false, lang = 'ar', defPrompt = null;
        let isSound = false;
        let audioCtx = null;
        
        const colors = [
            '#1e3c72', '#2563eb', '#059669', '#dc2626', 
            '#d97706', '#9333ea', '#0891b2', '#db2777', 
            '#57534e', '#475569', '#4f46e5', '#0d9488'
        ];

        // Ù†ØµÙˆØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const uiText = {
            ar: {
                appTitle: 'Ø§Ù„Ù…Ø³Ø¨Ø­Ø© Ø§Ù„Ø°ÙƒÙŠØ©',
                colorBtn: 'ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù…Ø³Ø¨Ø­Ø©',
                voiceBtn: 'ğŸ¤ ØµÙˆØªÙŠ',
                voiceBtnActive: 'â¹ Ø¥ÙŠÙ‚Ø§Ù',
                resetBtn: 'ğŸ”„ ØªØµÙÙŠØ±',
                azkarTitle: 'Ø£Ø°ÙƒØ§Ø±ÙŠ', 
                addZekrPlaceholder: 'Ø£ÙƒØªØ¨ Ø§Ù„Ø°ÙƒØ± Ù‡Ù†Ø§...',
                addZekrInfoPlaceholder: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
                addBtn: 'â• Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ± Ø¬Ø¯ÙŠØ¯',
                optTitle: 'Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª',
                notesTitle: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
                optSound: 'Ø§Ù„ØµÙˆØª',
                optNight: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ',
                optLang: 'Ø§Ù„Ù„ØºØ©',
                currLang: 'English',
                optBg: 'ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©',
                delBgBtn: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø®Ù„ÙÙŠØ©',
                installBtn: 'ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
                iosTitle: 'ØªØ«Ø¨ÙŠØª Ù„Ù„Ø¢ÙŠÙÙˆÙ† (iOS)',
                ios1: 'Ø§ÙØªØ­ ÙÙŠ Safari.',
                ios2: 'Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.',
                ios3: 'Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".',
                andTitle: 'ØªØ«Ø¨ÙŠØª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯',
                and1: 'Ø§ÙØªØ­ ÙÙŠ Chrome.',
                and2: 'Ø§Ø¶ØºØ· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (3 Ù†Ù‚Ø§Ø·).',
                and3: 'Ø§Ø®ØªØ± "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚".',
                colorModalTitle: 'Ù„ÙˆÙ† Ø§Ù„Ù…Ø³Ø¨Ø­Ø©',
                closeBtn: 'Ø¥ØºÙ„Ø§Ù‚',
                navTasbih: 'ØªØ³Ø¨ÙŠØ­',
                navAzkar: 'Ø£Ø°ÙƒØ§Ø±ÙŠ',
                navSettings: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                confirmReset: 'ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ',
                confirmDel: 'Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø°ÙƒØ±ØŸ',
                confirmDelBg: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ù„ÙÙŠØ©',
                voiceNotSupported: 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…',
                voiceStart: 'ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†',
                lastHeardLabel: 'Ø¢Ø®Ø± Ø°ÙƒØ± ØªÙ… Ø³Ù…Ø§Ø¹Ù‡:'
            },
            en: {
                appTitle: 'Smart Tasbih',
                colorBtn: 'ğŸ¨ Color',
                voiceBtn: 'ğŸ¤ Voice',
                voiceBtnActive: 'â¹ Stop',
                resetBtn: 'ğŸ”„ Reset',
                azkarTitle: 'My Azkar',
                addZekrPlaceholder: 'Write here...',
                addZekrInfoPlaceholder: 'Info (optional)',
                addBtn: 'â• Add New Zekr',
                optTitle: 'Options',
                notesTitle: 'Notes',
                optSound: 'Sound',
                optNight: 'Night Mode',
                optLang: 'Language',
                currLang: 'Ø¹Ø±Ø¨ÙŠ',
                optBg: 'Change Background',
                delBgBtn: 'ğŸ—‘ï¸ Remove BG',
                installBtn: 'ğŸ“² Install App',
                iosTitle: 'Install on iOS',
                ios1: 'Open in Safari.',
                ios2: 'Tap Share button.',
                ios3: 'Select "Add to Home Screen".',
                andTitle: 'Install on Android',
                and1: 'Open in Chrome.',
                and2: 'Tap Menu (3 dots).',
                and3: 'Select "Install App".',
                colorModalTitle: 'Pick Color',
                closeBtn: 'Close',
                navTasbih: 'Tasbih',
                navAzkar: 'Azkar',
                navSettings: 'Settings',
                confirmReset: 'Reset?',
                confirmDel: 'Delete?',
                confirmDelBg: 'Background removed',
                voiceNotSupported: 'Not supported',
                voiceStart: 'Speak now',
                lastHeardLabel: 'Last heard:'
            }
        };

        const Storage = {
            s: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
            l: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d } catch(e) { return d } },
            r: (k) => localStorage.removeItem(k)
        };

        const Toast = (m) => {
            const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const DateCtrl = {
            update: () => {
                const d = new Date();
                let txt;
                if (lang === 'ar') txt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {day:'numeric', month:'short', year:'numeric'}).format(d);
                else txt = new Intl.DateTimeFormat('en-US', {day:'numeric', month:'short', year:'numeric'}).format(d);
                document.getElementById('dateDisplay').textContent = txt;
            }
        };

        const playClick = () => {
            if (!isSound) return;
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = 600;
            osc.type = 'sine';
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        };

        const Tasbih = {
            touchStart: (e) => { e.preventDefault(); Tasbih.press(e); },
            mouseDown: (e) => { Tasbih.press(e); },
            mouseUp: () => { document.getElementById('tasbihBtn').classList.remove('pressed'); },
            press: (e) => {
                const btn = document.getElementById('tasbihBtn');
                if (e && (e.clientX || (e.touches && e.touches[0]))) {
                    const rect = btn.getBoundingClientRect();
                    const x = (e.clientX || e.touches[0].clientX) - rect.left;
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    const circle = document.createElement('span');
                    circle.classList.add('ripple-effect');
                    circle.style.left = `${x}px`;
                    circle.style.top = `${y}px`;
                    btn.appendChild(circle);
                    setTimeout(() => circle.remove(), 500);
                }
                
                count++;
                document.getElementById('counter').textContent = count;
                Storage.s('cnt', count);
                
                btn.classList.add('pressed');
                setTimeout(() => btn.classList.remove('pressed'), 150);
                
                playClick();
            },
            reset: () => {
                if(confirm(uiText[lang].confirmReset)) { count = 0; document.getElementById('counter').textContent = 0; Storage.s('cnt', 0); }
            }
        };

        const Settings = {
            toggleSound: () => {
                isSound = !isSound;
                document.getElementById('soundToggle').classList.toggle('active', isSound);
                Storage.s('sound', isSound);
                if(isSound && !audioCtx) {
                     audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                     playClick(); 
                }
            },
            theme: () => {
                isDark = !isDark;
                document.body.classList.toggle('dark-mode', isDark);
                document.getElementById('themeToggle').classList.toggle('active', isDark);
                Storage.s('dark', isDark);
            },
            lang: () => {
                lang = lang === 'ar' ? 'en' : 'ar';
                Settings.applyLang();
                Storage.s('lang', lang);
            },
            applyLang: () => {
                document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
                DateCtrl.update();
                Azkar.load();
                const t = uiText[lang];
                
                const ids = ['appTitle','colorBtnMain','voiceBtn','resetBtn','azkarTitle','addZekrBtn','optTitle','notesTitle',
                            'optSound','optNight','optLang','currLang','optBg','delBgBtn','installBtnTxt',
                             'iosTitle','iosStep1','iosStep2','iosStep3','androidTitle','andStep1','andStep2','andStep3',
                             'colorModalTitle','closeColorBtn','navTasbih','navAzkar','navSettings','lastHeardLabel'];
                
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.textContent = t[id.replace('Step','').replace('BtnMain','Btn').replace('BtnTxt','Btn')] || t[id];
                });
                
                document.getElementById('zekrText').placeholder = t.addZekrPlaceholder;
                document.getElementById('zekrInfo').placeholder = t.addZekrInfoPlaceholder;
                if(!isVoice) document.getElementById('voiceBtn').textContent = t.voiceBtn;
            }
        };

        const Voice = {
            lastTxt: '', lastTime: 0,
            init: () => {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SR) return;
                rec = new SR(); rec.continuous = true; rec.lang = 'ar-SA'; rec.interimResults = true;
                rec.onresult = (e) => {
                    const now = Date.now();
                    if (now - Voice.lastTime < 200) return;
                    for (let i = e.results.length - 1; i >= e.resultIndex; i--) {
                        if (e.results[i].isFinal || e.results[i][0].confidence > 0.65) {
                             const transcript = e.results[i][0].transcript.trim();
                             if (Voice.lastTxt !== transcript) {
                                Voice.lastTxt = transcript; Voice.lastTime = now;
                                Tasbih.press();
                                document.getElementById('lastDetected').textContent = transcript;
                                return;
                             }
                        }
                    }
                };
                rec.onend = () => { if (isVoice) rec.start(); };
            },
            toggle: () => {
                if (!rec) return Toast(uiText[lang].voiceNotSupported);
                isVoice = !isVoice;
                const btn = document.getElementById('voiceBtn');
                if (isVoice) { 
                    rec.start(); btn.classList.add('active'); btn.textContent = uiText[lang].voiceBtnActive; 
                    Toast(uiText[lang].voiceStart); 
                } else { 
                    rec.stop(); btn.classList.remove('active'); btn.textContent = uiText[lang].voiceBtn; 
                }
            },
            reset: () => { Voice.lastTxt = ''; }
        };

        const ColorPicker = {
            init: () => {
                document.getElementById('colorGrid').innerHTML = colors.map(c => 
                    `<div class="color-circle" style="background:${c}" onclick="ColorPicker.set('${c}')"></div>`
                ).join('');
            },
            open: () => document.getElementById('colorModal').classList.add('show'),
            close: (e, f) => { if(f || e.target.id === 'colorModal') document.getElementById('colorModal').classList.remove('show') },
            set: (c) => {
                document.documentElement.style.setProperty('--btn-color', c);
                Storage.s('btnCol', c);
                ColorPicker.close(null, true);
            }
        };

        const Azkar = {
            add: () => {
                const tx = document.getElementById('zekrText');
                const info = document.getElementById('zekrInfo');
                const textVal = tx.value.trim();
                if (!textVal) { tx.focus(); return; }
                
                const arr = Storage.l('azk', []);
                const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
                arr.unshift({id: newId, t: textVal, i: info.value.trim()});
                Storage.s('azk', arr); 
                tx.value = ''; info.value = ''; Azkar.load();
                Toast(lang === 'ar' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©' : 'Added');
            },
            load: () => {
                const arr = Storage.l('azk', []);
                const list = document.getElementById('myAzkarList');
                list.innerHTML = '';

                if (arr.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>${lang==='ar'?'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©ØŒ Ø£Ø¶Ù Ø£Ø°ÙƒØ§Ø±Ùƒ Ø§Ù„Ø®Ø§ØµØ©':'List is empty'}</p>
                        </div>`;
                    return;
                }

                arr.forEach(z => {
                    const card = document.createElement('div');
                    card.className = 'zekr-card';
                    card.id = `zekr-${z.id}`;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'zekr-content';

                    const txtSpan = document.createElement('span');
                    txtSpan.className = 'zekr-txt';
                    txtSpan.textContent = z.t;

                    const subDiv = document.createElement('div');
                    subDiv.className = 'zekr-sub';
                    subDiv.textContent = z.i || '';

                    contentDiv.appendChild(txtSpan);
                    contentDiv.appendChild(subDiv);

                    const delBtn = document.createElement('button');
                    delBtn.className = 'del-btn-icon';
                    delBtn.innerHTML = 'âœ•';
                    delBtn.onclick = () => Azkar.del(z.id);

                    card.appendChild(contentDiv);
                    card.appendChild(delBtn);
                    list.appendChild(card);
                });
            },
            del: (id) => {
                if(confirm(uiText[lang].confirmDel)) {
                    const card = document.getElementById(`zekr-${id}`);
                    if(card) {
                        card.classList.add('removing');
                        setTimeout(() => {
                            let arr = Storage.l('azk', []);
                            arr = arr.filter(z => z.id !== id);
                            Storage.s('azk', arr); Azkar.load();
                        }, 300);
                    } else {
                        let arr = Storage.l('azk', []);
                        arr = arr.filter(z => z.id !== id);
                        Storage.s('azk', arr); Azkar.load();
                    }
                }
            }
        };

        const BG = {
            change: (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = v => {
                        document.body.style.backgroundImage = `url(${v.target.result})`;
                        document.body.style.backgroundSize = 'cover';
                        Storage.s('bg', v.target.result);
                    };
                    r.readAsDataURL(f);
                }
            },
            remove: () => { document.body.style.backgroundImage = ''; Storage.r('bg'); Toast(uiText[lang].confirmDelBg); }
        };

        const Nav = {
            show: (id) => {
                document.querySelectorAll('.content-section').forEach(e => e.classList.remove('active'));
                document.getElementById(id+'-section').classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
                const idx = id === 'tasbih' ? 0 : (id === 'my-azkar' ? 1 : 2);
                document.querySelectorAll('.nav-btn')[idx].classList.add('active');
                if(id === 'my-azkar') Azkar.load();
            }
        };

        const PWA = {
            install: () => { 
                if(defPrompt) { 
                    defPrompt.prompt(); 
                    defPrompt.userChoice.then(c => { 
                        if(c.outcome==='accepted') {
                            document.getElementById('topInstallIcon').classList.add('hidden');
                            document.getElementById('settingsInstallBtn').classList.add('hidden');
                        }
                    }); 
                } 
            }
        };

        const swCode = `
            const CACHE_NAME = 'tasbih-v3';
            self.addEventListener('install', e => {
                e.waitUntil(
                    caches.open(CACHE_NAME).then(cache => {
                        return cache.addAll(['./', 'https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap']);
                    })
                );
            });
            self.addEventListener('fetch', e => {
                e.respondWith(caches.match(e.request).then(res => res || fetch(e.request).catch(() => caches.match('./'))));
            });
        `;

        window.addEventListener('load', () => {
            count = Storage.l('cnt', 0); document.getElementById('counter').textContent = count;
            isSound = Storage.l('sound', false); document.getElementById('soundToggle').classList.toggle('active', isSound);
            
            if(Storage.l('dark')) { isDark=true; document.body.classList.add('dark-mode'); document.getElementById('themeToggle').classList.add('active'); }
            const c = Storage.l('btnCol'); if(c) document.documentElement.style.setProperty('--btn-color', c);
            const b = Storage.l('bg'); if(b) { document.body.style.backgroundImage = `url(${b})`; document.body.style.backgroundSize='cover'; }
            
            lang = Storage.l('lang', 'ar');
            Settings.applyLang();
            ColorPicker.init(); Voice.init();
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); defPrompt = e;
                document.getElementById('topInstallIcon').classList.remove('hidden');
                document.getElementById('settingsInstallBtn').classList.remove('hidden');
            });
            
            if('serviceWorker' in navigator) {
                const blob = new Blob([swCode], {type: 'application/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(blob));
            }
        });
    </script>
</body>
</html>

